<script>

var data = []
var sort = ""
var timer = 0
var lastScrollTop = 0;
var fontSizes = {
  arrow: "1.0rem",
  th: "1.0rem",
  td: "1.0rem",
  input: "1.0rem",
  div: "1.0rem"
}

const svgPen = `
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
    <path d="M12 20h9" />
    <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
  </svg>
`;

const svgFilter = `
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
    <polygon points="3 5 21 5 14 12 14 19 10 21 10 12 3 5" />
  </svg>
`;

const svgGram = `
  <svg width="24" height="24" viewBox="0 0 24 24"
       fill="none" stroke="currentColor" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round">
    <!-- Rondere buitenboog -->
    <path d="M16 8c0-3-2.5-5-5.5-5S5 5 5 8v8c0 3 2.5 5 5.5 5S16 19 16 16v-3h-5" />
  </svg>
`

const svgVoc = `
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
    <!-- V as path -->
    <path d="M4 4l8 16 8-16" />
  </svg>
`
/***************************/
/***** CRUD Operations *****/
/***************************/

function readAll() {

  showSpinner()

   google.script.run
  .withSuccessHandler(function(response){

    data = response;
    sort = "hungarianAZ"
    filterAndSort()
    closeSpinner()
    closeInputBox()
  })
  .readAll();
}

function showAll(processed) {

  let tbody = document.querySelector("tbody")
  tbody.innerHTML = ""

  processed.forEach(d => {

     let row = document.createElement("tr");
     row.id = "M"+d[0]
     let boxHu = document.createElement("td");
     boxHu.innerHTML = d[1]
     boxHu.classList.add("dblclick-select")
     let boxNl = document.createElement("td");
     boxNl.innerHTML = d[2]
     boxNl.classList.add("dblclick-select")

     row.appendChild(boxHu)
     row.appendChild(boxNl)

     tbody.appendChild(row)
  })

  let elements = document.querySelectorAll("*");
  // let elements = document.querySelectorAll("th, th.sort-arrow, td, input, div[contenteditable='true']");
  elements.forEach(el => {
    setFontSizeRem(el)
  })

}

function createOne() {
  showInputBox("first")
  document.querySelector("#btn-save").dataset.clickedId = "";
}

function selectOne(e) {

  showInputBox()
   
  let rowId = e.target.closest("tr").id  
  rowId = parseInt(rowId.slice(1)); 
  document.querySelector("#btn-save").dataset.clickedId = rowId;
  document.querySelector("#btn-delete").dataset.clickedId = rowId;

  let indexInData = data.findIndex(row => row[0] == rowId)
  document.querySelector("#hu").innerHTML = data[indexInData][1]
  document.querySelector("#nl").innerHTML = data[indexInData][2]
}

function deleteOne() {

  let confirmDelete = confirm("Weet je zeker dat je deze vertaling wilt verwijderen?");
  if (!confirmDelete) return;

  showSpinner();

  let id = document.querySelector("#btn-delete").dataset.clickedId

  google.script.run
  .withSuccessHandler(function(response){
  
    data = response;
    filterAndSort()
    closeSpinner()
    closeInputBox()
  })
  .deleteOne(id);
}

function saveOne() {

  let hu = document.querySelector("#hu").textContent.trim();
  let nl = document.querySelector("#nl").textContent.trim();

  if (!hu || !nl) {
    alert("Beide velden, Magyar en Nederlands, moeten ingevuld zijn!");
    return;  // Stop opslaan als een veld leeg is
  }


  let id = document.querySelector("#btn-save").dataset.clickedId
  let saved = []

  if (id) {
    saved = [id, hu, nl]
  } else {
    saved = ["", hu, nl]
  }

  showSpinner();

  google.script.run
  .withSuccessHandler(function(response){

    data = response;
    filterAndSort()
    closeSpinner()
    closeInputBox()


  })
  .saveOne(saved);
}

/***************************/
/***** FILTER AND SORT *****/
/***************************/

function filterAndSort() {

  let term = document.querySelector("#search-input").value
  let lowerTerm = term.toLowerCase()
  let processed = data


  if (term) {
    document.querySelector("#btn-box").innerHTML = svgFilter
    processed = data.filter(row => {
      return row[1].toLowerCase().includes(lowerTerm) ||
            row[2].toLowerCase().includes(lowerTerm);
    });
  } else {
    document.querySelector("#btn-box").innerHTML = svgPen
  }

  switch (sort) {
    case "hungarianAZ":
      processed.sort((a, b) => 
        a[1].localeCompare(b[1], "hu", { sensitivity: 'base', ignorePunctuation: true }) * 1
      );
      break;
    case "hungarianZA":
      processed.sort((a, b) => 
        a[1].localeCompare(b[1], "hu", { sensitivity: 'base', ignorePunctuation: true }) * -1
      );
      break;
    case "dutchAZ":
      processed.sort((a, b) => 
        a[2].localeCompare(b[2], "nl", { sensitivity: 'base', ignorePunctuation: true }) * 1
      );
      break;
    case "dutchZA":
      processed.sort((a, b) => 
        a[2].localeCompare(b[2], "nl", { sensitivity: 'base', ignorePunctuation: true }) * -1
      );
      break;
    default:
      processed.sort((a, b) => 
        a[1].localeCompare(b[1], "hu", { sensitivity: 'base', ignorePunctuation: true }) * 1
      );
  }

  let amount = processed.length;
  let showMatches = document.querySelector("#found-search-input")

  if (term != "") {
    amount != 1 ? showMatches.innerHTML = amount+" overeenkomsten" : showMatches.innerHTML = 1+" overeenkomst" ;
  } else {
    showMatches.innerHTML = "";
  }
 
  showAll(processed)
}

function clearSortIndicators() {
  document.querySelectorAll("th").forEach(th => {
    th.classList.remove("asc", "desc");
  });
}

function updateSortIndicators(column, direction) {
  clearSortIndicators();
  const th = document.querySelector(`th[data-column="${column}"]`);
  if (th) {
    th.classList.add(direction);
  }
}

function evaluateSort(e) {
  let th = e.target.matches("thead th") ? e.target : e.target.closest("thead th");
  let column = parseInt(th.dataset.column);
  if (!column) return;

  // Bepaal huidige en nieuwe sorteer richting
  let currentDirection = th.dataset.sortDirection || "asc";
  let newDirection = currentDirection === "asc" ? "desc" : "asc";
  th.dataset.sortDirection = newDirection;

  // Update globale sort variabele
  if (column === 1) {
    sort = newDirection === "asc" ? "hungarianAZ" : "hungarianZA";
  }
  if (column === 2) {
    sort = newDirection === "asc" ? "dutchAZ" : "dutchZA";
  }

  updateSortIndicators(column, newDirection);
  filterAndSort();
}

/*****************************/
/***** LAYOUT OPERATIONS *****/
/*****************************/

function toggleScreens() {

  let btnScreen = document.querySelector("#btn-screen")
  btnScreen.classList.toggle("grammar-opened")

  if (btnScreen.classList.contains("grammar-opened")) {
    document.querySelector("#input-box").style.display = "none";
    document.querySelector("#overlay").style.display = "none";
    document.querySelector("#spinner").style.display = "none";
    document.querySelector("#btn-box").style.display = "none";
    document.querySelector("#vocabulary").style.display = "none";
    document.querySelector("#grammar").style.display = "block";
    btnScreen.innerHTML = svgVoc
  } else {
    document.querySelector("#btn-box").style.display = "block"
    document.querySelector("#vocabulary").style.display = "block"
    document.querySelector("#grammar").style.display = "none"
    btnScreen.innerHTML = svgGram
  }
}

function toggleExpandButton(e) {

  console.log("WAAROM?")

  let summary = e.target.closest(".with-expand-button")
  let button = summary.querySelector(".btn-expand")
  let details = summary.closest("details")

  if (details.open) { // the open will be set after the code underneath
    summary.style.padding = "10px 14px";
    summary.style.justifyContent = "flex-start";
    button.style.display = "none";
  } else {
    summary.style.padding = "0px 14px";
    summary.style.justifyContent = "space-between";
    button.style.display = "flex";
  }

  

}

function toggleAllChildrenDetails(e) {

  console.log("HALLO")

  let button = e.target.closest(".btn-expand")
  let details = button.closest("details")
  let detlvl2 = details.querySelectorAll(".det-lvl2")
  let detlvl3 = details.querySelectorAll(".det-lvl3")

  let value = parseInt(button.value, 10) //Always use radix 10 to avoid issues with octal interpretation.
  value != 3 ? button.value = value+1 : button.value = 1 ;

  // lvl2 and lvl3 closed
  if (button.value == 1) {
    for (let a of detlvl2) {a.removeAttribute("open")}
    for (let b of detlvl3) {b.removeAttribute("open")}
  }
  
  // lvl2 opened; lvl3 closed
  if (button.value == 2) {
    for (let a of detlvl2) {a.setAttribute("open", "")}
    for (let b of detlvl3) {b.removeAttribute("open")}
  }

  // lvl2 and lvl3 opened;
  if (button.value == 3) {
    for (let a of detlvl2) {a.setAttribute("open", "")}
    for (let b of detlvl3) {b.setAttribute("open", "")}
  }



}

function closeDetails(e) {

  // Ignore double-clicks on the <summary>
  if (e.target.closest('summary')) return;

  let details = e.target.closest(".det-lvl3[open]");
  if (details) {
    details.removeAttribute("open");
  }
}

/***** FONT SIZING *****/
  
function setFontSizeRem(el, newSize = "") {
  let size;

  if (el.tagName === 'TH') {
    if (el.classList.contains('sort-arrow')) {
      size = newSize || fontSizes.arrow;
      if (newSize) fontSizes.arrow = newSize;
    } else {
      size = newSize || fontSizes.th;
      if (newSize) fontSizes.th = newSize;
    }
  }
  if (el.tagName === 'TD') {
    size = newSize || fontSizes.td;
    if (newSize) fontSizes.td = newSize;
  }
  
  if (el.tagName === 'INPUT') {
    size = newSize || fontSizes.input;
    if (newSize) fontSizes.input = newSize;
  }
  
  if (el.tagName === 'DIV') {
    size = newSize || fontSizes.div;
    if (newSize) fontSizes.div = newSize;
  }

  if (size) el.style.fontSize = size;
}


function increaseFontSizeRem() {

 let step = 0.1
 let elements = document.querySelectorAll("*");

  elements.forEach(el => {
    let current = window.getComputedStyle(el).fontSize;
    let fontSizePx = parseFloat(current);               // current size in px
    let rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize); // base size (usually 16px)
    let currentRem = fontSizePx / rootFontSize;         // convert px to rem
    let newRem = (currentRem + step).toFixed(2);        // increase in rem
    setFontSizeRem(el, newRem + "rem")
  });
}

function decreaseFontSizeRem() {
  let step = 0.1
  let elements = document.querySelectorAll("*");

  elements.forEach(el => {
    const current = window.getComputedStyle(el).fontSize;
    const fontSizePx = parseFloat(current);               // current size in px
    const rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize); // base size (usually 16px)
    const currentRem = fontSizePx / rootFontSize;         // convert px to rem
    const newRem = (currentRem - step).toFixed(2);        // increase in rem
    setFontSizeRem(el, newRem + "rem")
  });
}



/***** INPUTBOX VISIBILITY *****/

function showInputBox(first = "") {

  document.querySelector("#input-box").style.display = "block"
  document.querySelector("#overlay").style.display = "block"
  document.querySelector("#btn-box").style.display = "none"

  if (!first) {
    document.querySelector("#btn-delete").style.display = "block"
  } else {
    document.querySelector("#btn-delete").style.display = "none"
  }
}

function closeInputBox() {

  document.querySelector("#input-box").style.display = "none"
  document.querySelector("#overlay").style.display = "none"
  document.querySelector("#btn-box").style.display = "block"
  document.querySelector("#hu").innerHTML = ""
  document.querySelector("#nl").innerHTML = ""

}



/***** SPINNER VISIBILITY *****/

function showSpinner() {
  document.getElementById("spinner").style.display = "block";
}

function closeSpinner() {
  document.getElementById("spinner").style.display = "none";
}



/****************************/
/****** EVENT HANDLERS ******/
/****************************/

['btn-box', 'btn-screen', 'btn-increase', 'btn-decrease'].forEach(id => {
    const btn = document.getElementById(id);
    btn.addEventListener('mousedown', () => {
      btn.classList.add('pressed');
    });
    btn.addEventListener('mouseup', () => {
      btn.classList.remove('pressed');
    });
    btn.addEventListener('mouseleave', () => {
      btn.classList.remove('pressed');
    });
    // Voor touchscreens
    btn.addEventListener('touchstart', () => {
      btn.classList.add('pressed');
    });
    btn.addEventListener('touchend', () => {
      btn.classList.remove('pressed');
    });
    btn.addEventListener('touchcancel', () => 
      btn.classList.remove('pressed')
    );
  });

function clickEventHandler(e) {

  if (e.target.matches("#btn-box")) { createOne() }
  if (e.target.matches("#btn-screen")) { toggleScreens() }
  if (e.target.matches("#btn-increase")) { increaseFontSizeRem() }
  if (e.target.matches("#btn-decrease")) { decreaseFontSizeRem() }
  if (e.target.matches("#btn-save")) { saveOne() }
  if (e.target.matches("#btn-delete")) { deleteOne() }
  if (e.target.matches("#overlay")) { closeInputBox() }
  if (e.target.matches("thead th") || e.target.closest("thead th")) { evaluateSort(e) }
  if (e.target.matches("thead th") || e.target.closest("thead th")) { evaluateSort(e) }
  if (e.target.matches(".with-expand-button")) { toggleExpandButton(e) }
  if (e.target.closest(".btn-expand")) { toggleAllChildrenDetails(e) }
}


function doubleClickEventHandler(e) {
  if (e.target.matches(".dblclick-select")) { selectOne(e) }
  if (e.target.matches("#search-input")) { e.target.value = ""; filterAndSort() }
  if (e.target.closest(".det-lvl3[open]")) {closeDetails(e)} // to close when the details are open
 
}

function keyDownEventHandler(e) {

  let btnSave = document.querySelector("#btn-save");
  let btnSaveStyle = window.getComputedStyle(btnSave);

  let spinner = document.querySelector("#spinner");
  let spinnerStyle = window.getComputedStyle(spinner);

   if (e.key == "Enter") {
    e.preventDefault();
    if (btnSaveStyle.display == "block" && spinnerStyle.display == "none") {
      saveOne()
    }
  }
}

function inputEventHandler(e) {
   if (e.target.matches("#search-input")) { filterAndSort() }
}

function scrollEventHandler(e) {

  let currentScroll = window.pageYOffset || document.documentElement.scrollTop;
  let thead = document.querySelector("thead");

  if (currentScroll > lastScrollTop) {
    // Scrolling down
    thead.style.transform = "translateY(-100%)";
  } else {
    // Scrolling up
    thead.style.transform = "translateY(0)";
  }

  lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
}

function touchStartEventHandler(e) {
 /* if (e.target.matches(".dblclick-select")) { 
    timer = setTimeout(() => { selectOne(e) }, 750);
  }*/

  if (e.target.matches("#search-input")) { 
    timer = setTimeout(() => { e.target.value = "";  filterAndSort() }, 750);
  }
}

function touchEndEventHandler(e) {
 // if (e.target.matches(".dblclick-select")) { clearTimeout(timer) }
}

function touchCancelEventHandler(e) {
 // if (e.target.matches(".dblclick-select")) { clearTimeout(timer) }
} 

document.addEventListener("DOMContentLoaded", () => { readAll() })
document.getElementsByTagName("body")[0].addEventListener("click", clickEventHandler);
document.getElementsByTagName("body")[0].addEventListener("dblclick", doubleClickEventHandler);
document.getElementsByTagName("body")[0].addEventListener("input", inputEventHandler);
document.getElementsByTagName("body")[0].addEventListener("keydown", keyDownEventHandler);
document.getElementsByTagName("body")[0].addEventListener("touchstart", touchStartEventHandler);
document.getElementsByTagName("body")[0].addEventListener("touchend", touchEndEventHandler);
document.getElementsByTagName("body")[0].addEventListener("touchcancel", touchCancelEventHandler);
window.addEventListener("scroll", scrollEventHandler);



</script>