<script>

var data = []
var sort = ""
var timer = 0
var lastScrollTop = 0;
var fontSizes = {
  arrow: "1.0rem",
  th: "1.1rem",
  td: "1.1rem",
  input: "1.1rem",
  div: "1.1rem"
}
const svgPen = `
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
    <path d="M12 20h9" />
    <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
  </svg>
`;

const svgFilter = `
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
    <polygon points="3 5 21 5 14 12 14 19 10 21 10 12 3 5" />
  </svg>
`;


/***************************/
/***** CRUD Operations *****/
/***************************/

function readAll() {

  showSpinner()

   google.script.run
  .withSuccessHandler(function(response){

    data = response;
    sort = "hungarianAZ"
    filterAndSort()
    closeSpinner()
    closeInputBox()
  })
  .readAll();
}

function showAll(processed) {

  let tbody = document.querySelector("tbody")
  tbody.innerHTML = ""

  processed.forEach(d => {

     let row = document.createElement("tr");
     row.id = "M"+d[0]
     let boxHu = document.createElement("td");
     boxHu.innerHTML = d[1]
     boxHu.classList.add("dblclick-select")
     let boxNl = document.createElement("td");
     boxNl.innerHTML = d[2]
     boxNl.classList.add("dblclick-select")

     row.appendChild(boxHu)
     row.appendChild(boxNl)

     tbody.appendChild(row)
  })

  let elements = document.querySelectorAll("th, th.sort-arrow, td, input, div[contenteditable='true']");
  elements.forEach(el => {
    setFontSizeRem(el)
  })

}

function createOne() {
  showInputBox("first")
  document.querySelector("#btn-save").dataset.clickedId = "";
}

function selectOne(e) {

  showInputBox()
   
  let rowId = e.target.closest("tr").id  
  rowId = parseInt(rowId.slice(1)); 
  document.querySelector("#btn-save").dataset.clickedId = rowId;
  document.querySelector("#btn-delete").dataset.clickedId = rowId;

  let indexInData = data.findIndex(row => row[0] == rowId)
  document.querySelector("#hu").innerHTML = data[indexInData][1]
  document.querySelector("#nl").innerHTML = data[indexInData][2]
}

function deleteOne() {

  let confirmDelete = confirm("Weet je zeker dat je deze vertaling wilt verwijderen?");
  if (!confirmDelete) return;

  showSpinner();

  let id = document.querySelector("#btn-delete").dataset.clickedId

  google.script.run
  .withSuccessHandler(function(response){
  
    data = response;
    filterAndSort()
    closeSpinner()
    closeInputBox()
  })
  .deleteOne(id);
}

function saveOne() {

  let hu = document.querySelector("#hu").textContent.trim();
  let nl = document.querySelector("#nl").textContent.trim();

  if (!hu || !nl) {
    alert("Beide velden, Magyar en Nederlands, moeten ingevuld zijn!");
    return;  // Stop opslaan als een veld leeg is
  }


  let id = document.querySelector("#btn-save").dataset.clickedId
  let saved = []

  if (id) {
    saved = [id, hu, nl]
  } else {
    saved = ["", hu, nl]
  }

  showSpinner();

  google.script.run
  .withSuccessHandler(function(response){

    data = response;
    filterAndSort()
    closeSpinner()
    closeInputBox()


  })
  .saveOne(saved);
}

/***************************/
/***** FILTER AND SORT *****/
/***************************/

function filterAndSort() {

  console.log("data")
   console.log(data)
  let term = document.querySelector("#search-input").value
  let lowerTerm = term.toLowerCase()
  let processed = data
  console.log("processed start")
  console.log(processed)

  if (term) {
    document.querySelector("#btn-add").innerHTML = svgFilter
    processed = data.filter(row => {
      return row[1].toLowerCase().includes(lowerTerm) ||
            row[2].toLowerCase().includes(lowerTerm);
    });
  } else {
    document.querySelector("#btn-add").innerHTML = svgPen
  }

  switch (sort) {
    case "hungarianAZ":
      processed.sort((a, b) => 
        a[1].localeCompare(b[1], "hu", { sensitivity: 'base', ignorePunctuation: true }) * 1
      );
      break;
    case "hungarianZA":
      processed.sort((a, b) => 
        a[1].localeCompare(b[1], "hu", { sensitivity: 'base', ignorePunctuation: true }) * -1
      );
      break;
    case "dutchAZ":
      processed.sort((a, b) => 
        a[2].localeCompare(b[2], "nl", { sensitivity: 'base', ignorePunctuation: true }) * 1
      );
      break;
    case "dutchZA":
      processed.sort((a, b) => 
        a[2].localeCompare(b[2], "nl", { sensitivity: 'base', ignorePunctuation: true }) * -1
      );
      break;
    default:
      processed.sort((a, b) => 
        a[1].localeCompare(b[1], "hu", { sensitivity: 'base', ignorePunctuation: true }) * 1
      );
  }
 
  showAll(processed)
}

function clearSortIndicators() {
  document.querySelectorAll("th").forEach(th => {
    th.classList.remove("asc", "desc");
  });
}

function updateSortIndicators(column, direction) {
  clearSortIndicators();
  const th = document.querySelector(`th[data-column="${column}"]`);
  if (th) {
    th.classList.add(direction);
  }
}

function evaluateSort(e) {
  let th = e.target.matches("thead th") ? e.target : e.target.closest("thead th");
  let column = parseInt(th.dataset.column);
  if (!column) return;

  // Bepaal huidige en nieuwe sorteer richting
  let currentDirection = th.dataset.sortDirection || "asc";
  let newDirection = currentDirection === "asc" ? "desc" : "asc";
  th.dataset.sortDirection = newDirection;

  // Update globale sort variabele
  if (column === 1) {
    sort = newDirection === "asc" ? "hungarianAZ" : "hungarianZA";
  }
  if (column === 2) {
    sort = newDirection === "asc" ? "dutchAZ" : "dutchZA";
  }

  updateSortIndicators(column, newDirection);
  filterAndSort();
}

/*****************************/
/***** LAYOUT OPERATIONS *****/
/*****************************/

  
function setFontSizeRem(el, newSize = "") {
  let size;

  if (el.tagName === 'TH') {
    if (el.classList.contains('sort-arrow')) {
      size = newSize || fontSizes.arrow;
      if (newSize) fontSizes.arrow = newSize;
    } else {
      size = newSize || fontSizes.th;
      if (newSize) fontSizes.th = newSize;
    }
  }
  if (el.tagName === 'TD') {
    size = newSize || fontSizes.td;
    if (newSize) fontSizes.td = newSize;
  }
  
  if (el.tagName === 'INPUT') {
    size = newSize || fontSizes.input;
    if (newSize) fontSizes.input = newSize;
  }
  
  if (el.tagName === 'DIV') {
    size = newSize || fontSizes.editable;
    if (newSize) fontSizes.editable = newSize;
  }

  if (size) el.style.fontSize = size;
}


function increaseFontSizeRem() {

 let step = 0.1
 let elements = document.querySelectorAll("th, th.sort-arrow, td, input, div[contenteditable='true']");

  elements.forEach(el => {
    let current = window.getComputedStyle(el).fontSize;
    let fontSizePx = parseFloat(current);               // current size in px
    let rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize); // base size (usually 16px)
    let currentRem = fontSizePx / rootFontSize;         // convert px to rem
    let newRem = (currentRem + step).toFixed(2);        // increase in rem
    setFontSizeRem(el, newRem + "rem")
  });
}

function decreaseFontSizeRem() {
  let step = 0.1
  let elements = document.querySelectorAll("th, td, input, div[contenteditable='true']");

  elements.forEach(el => {
    const current = window.getComputedStyle(el).fontSize;
    const fontSizePx = parseFloat(current);               // current size in px
    const rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize); // base size (usually 16px)
    const currentRem = fontSizePx / rootFontSize;         // convert px to rem
    const newRem = (currentRem - step).toFixed(2);        // increase in rem
    setFontSizeRem(el, newRem + "rem")
  });
}

function showInputBox(first = "") {

  document.querySelector("#input-box").style.display = "block"
  document.querySelector("#overlay").style.display = "block"
  document.querySelector("#btn-add").style.display = "none"

  if (!first) {
    document.querySelector("#btn-delete").style.display = "block"
  } else {
    document.querySelector("#btn-delete").style.display = "none"
  }
}

function closeInputBox() {

  document.querySelector("#input-box").style.display = "none"
  document.querySelector("#overlay").style.display = "none"
  document.querySelector("#btn-add").style.display = "block"
  document.querySelector("#hu").innerHTML = ""
  document.querySelector("#nl").innerHTML = ""

}

function showSpinner() {
  document.getElementById("spinner").style.display = "block";
}

function closeSpinner() {
  document.getElementById("spinner").style.display = "none";
}



/****************************/
/****** EVENT HANDLERS ******/
/****************************/

['btn-add', 'btn-increase', 'btn-decrease'].forEach(id => {
    const btn = document.getElementById(id);
    btn.addEventListener('mousedown', () => {
      btn.classList.add('pressed');
    });
    btn.addEventListener('mouseup', () => {
      btn.classList.remove('pressed');
    });
    btn.addEventListener('mouseleave', () => {
      btn.classList.remove('pressed');
    });
    // Voor touchscreens
    btn.addEventListener('touchstart', () => {
      btn.classList.add('pressed');
    });
    btn.addEventListener('touchend', () => {
      btn.classList.remove('pressed');
    });
    btn.addEventListener('touchcancel', () => 
      btn.classList.remove('pressed')
    );
  });

function clickEventHandler(e) {

  if (e.target.matches("#btn-add")) { createOne() }
  if (e.target.matches("#btn-increase")) { increaseFontSizeRem() }
  if (e.target.matches("#btn-decrease")) { decreaseFontSizeRem() }

  if (e.target.matches("#btn-save")) { saveOne() }
  if (e.target.matches("#btn-delete")) { deleteOne() }
  if (e.target.matches("#overlay")) { closeInputBox() }
  if (e.target.matches("thead th") || e.target.closest("thead th")) { evaluateSort(e) }
}


function doubleClickEventHandler(e) {
  if (e.target.matches(".dblclick-select")) { selectOne(e) }
  if (e.target.matches("#search-input")) { e.target.value = ""; filterAndSort() }
}

function keyDownEventHandler(e) {

  let btnSave = document.querySelector("#btn-save");
  let btnSaveStyle = window.getComputedStyle(btnSave);

  let spinner = document.querySelector("#spinner");
  let spinnerStyle = window.getComputedStyle(spinner);

   if (e.key == "Enter") {
    e.preventDefault();
    if (btnSaveStyle.display == "block" && spinnerStyle.display == "none") {
      saveOne()
    }
  }
}

function inputEventHandler(e) {
   if (e.target.matches("#search-input")) { filterAndSort() }
}

function scrollEventHandler(e) {

  let currentScroll = window.pageYOffset || document.documentElement.scrollTop;
  let thead = document.querySelector("thead");

  if (currentScroll > lastScrollTop) {
    // Scrolling down
    thead.style.transform = "translateY(-100%)";
  } else {
    // Scrolling up
    thead.style.transform = "translateY(0)";
  }

  lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
}

function touchStartEventHandler(e) {
  if (e.target.matches(".dblclick-select")) { 
    timer = setTimeout(() => { selectOne(e) }, 750);
  }

  if (e.target.matches("#search-input")) { 
    timer = setTimeout(() => { e.target.value = "";  filterAndSort() }, 750);
  }
}

function touchEndEventHandler(e) {
  if (e.target.matches(".dblclick-select")) { clearTimeout(timer) }
}

function touchCancelEventHandler(e) {
  if (e.target.matches(".dblclick-select")) { clearTimeout(timer) }
} 

document.addEventListener("DOMContentLoaded", () => { readAll() })
document.getElementsByTagName("body")[0].addEventListener("click", clickEventHandler);
document.getElementsByTagName("body")[0].addEventListener("dblclick", doubleClickEventHandler);
document.getElementsByTagName("body")[0].addEventListener("input", inputEventHandler);
document.getElementsByTagName("body")[0].addEventListener("keydown", keyDownEventHandler);
document.getElementsByTagName("body")[0].addEventListener("touchstart", touchStartEventHandler);
document.getElementsByTagName("body")[0].addEventListener("touchend", touchEndEventHandler);
document.getElementsByTagName("body")[0].addEventListener("touchcancel", touchCancelEventHandler);
window.addEventListener("scroll", scrollEventHandler);



</script>