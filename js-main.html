<script>

var vocabulary = []
var sentences = []
var sort = ""
var timer = 0
var lastScrollTop = 0;
var btnScreen = document.querySelector("#btn-screen")
var fontSizes = {
  arrow: "1.0rem",
  th: "1.0rem",
  td: "1.0rem",
  input: "1.0rem",
  div: "1.0rem"
}

const svgPen = `
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
    <path d="M12 20h9" />
    <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
  </svg>
`;

const svgFilter = `
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
    <polygon points="3 5 21 5 14 12 14 19 10 21 10 12 3 5" />
  </svg>
`;

const svgGram = `
  <svg width="24" height="24" viewBox="0 0 24 24"
       fill="none" stroke="currentColor" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round">
    <!-- Rondere buitenboog -->
    <path d="M16 8c0-3-2.5-5-5.5-5S5 5 5 8v8c0 3 2.5 5 5.5 5S16 19 16 16v-3h-5" />
  </svg>
`

const svgVoc = `
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
    <!-- V as path -->
    <path d="M4 4l8 16 8-16" />
  </svg>
`
const svgSent = `
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
    <path d="M18 4H9a4 4 0 0 0 0 8h6a4 4 0 0 1 0 8H6" />
  </svg>
`
/***************************/
/***** CRUD Operations *****/
/***************************/

function readAll(type) {

  showSpinner()

  google.script.run
  .withSuccessHandler(function(response){
    
    sort = "hungarianAZ"
    evaluateFilterAndSort(response)

  })
  .readAll(type);
}

function showAll(type, processed) {

  let container = type == "vocabulary" ? document.querySelector("#vocabulary tbody") : document.querySelector("#sentences")
  container.innerHTML = ""

  processed.forEach(d => {

    let row
    if (type == "vocabulary") {
      row = document.createElement("tr")
      row.id = "V"+d[0]
    } else {
      row = document.createElement("div");
      row.id = "S"+d[0]
      row.classList.add("explanation-box")
    }
    row.classList.add("dblclick-select")

    let boxHu
    if (type == "vocabulary") {
      boxHu = document.createElement("td")
    } else {
      boxHu = document.createElement("div")
      boxHu.classList.add("example-hu")
    }
    boxHu.innerHTML = d[1]

    let boxNl
    if (type == "vocabulary") {
      boxNl = document.createElement("td")
    } else {
      boxNl = document.createElement("div")
      boxNl.classList.add("example-nl")
    }
    boxNl.innerHTML = d[2]

    row.appendChild(boxHu)
    row.appendChild(boxNl)

    container.appendChild(row)
  })

  let elements = document.querySelectorAll("*");
  elements.forEach(el => {
    setFontSizeRem(el)
  })

}


function createOne() {
  showInputBox("first")
  document.querySelector("#btn-save").dataset.clickedId = "";
}

function selectOne(e) {

  showInputBox()
   
  /* put the id with letter in the button delete and save */
  let rowId = e.target.closest(".dblclick-select").id  
  document.querySelector("#btn-save").dataset.clickedId = rowId;
  document.querySelector("#btn-delete").dataset.clickedId = rowId;

  /* show the data from the saved array by looking with only the numeral part if the id */
  let data = btnScreen.value == 1 ? vocabulary : sentences ;
  let rowIdNumber = parseInt(rowId.slice(1)); 
  let indexInData = data.findIndex(row => row[0] == rowIdNumber)
  document.querySelector("#hu").innerHTML = data[indexInData][1]
  document.querySelector("#nl").innerHTML = data[indexInData][2]
}

function deleteOne() {

  let confirmDelete = confirm("Weet je zeker dat je dit wil verwijderen?");
  if (!confirmDelete) return;

  showSpinner();

  let id = document.querySelector("#btn-delete").dataset.clickedId

  google.script.run
  .withSuccessHandler(function(response){


    evaluateFilterAndSort(response)
 
  })
  .deleteOne(id);
}

function saveOne() {

  let huText = document.querySelector("#hu").textContent.trim();
  let nlText = document.querySelector("#nl").textContent.trim();

  if (!huText || !nlText) {
    alert("Beide velden, Magyar en Nederlands, moeten ingevuld zijn!");
    return;  // Stop opslaan als een veld leeg is
  }

  let huHTML = document.querySelector("#hu").innerHTML;
  let nlHTML = document.querySelector("#nl").innerHTML;

  let id = document.querySelector("#btn-save").dataset.clickedId
  let saved = []
  let type = btnScreen.value == 1 ? "vocabulary" : "sentences"


  if (id) {
    saved = [id, huHTML, nlHTML]
  } else {
    saved = ["", huHTML, nlHTML]
  }

  showSpinner();

  google.script.run
  .withSuccessHandler(function(response){

    evaluateFilterAndSort(response)

  })
  .saveOne(saved, type);
}

/***************************/
/***** FILTER AND SORT *****/
/***************************/

function evaluateFilterAndSort(response = "") {

  /* runs when data is put in the search inout */
  if (response == "") {
    filterAndSort("vocabulary", vocabulary)
    filterAndSort("sentences", sentences)
  }

  /* runs when CRUD operations are done */
  if (response != "") {
    if (response[0] != "") {
    vocabulary = response[0];
    filterAndSort("vocabulary", vocabulary)
    }

    if (response[1] != "") {
      sentences = response[1]
      filterAndSort("sentences", sentences)
    }

    closeSpinner()
    closeInputBox()
  }
  
}

function filterAndSort(type, data) {

  let term = document.querySelector("#search-input").value
  let lowerTerm = term.toLowerCase()
  let processed = data

  console.log("DATA BEFORE")
  console.log(data)


  if (term) {
    document.querySelector("#btn-box").innerHTML = svgFilter
    document.querySelector("#btn-box").classList.add("filter-symbol");
    processed = data.filter(row => {
      return row[1].toLowerCase().includes(lowerTerm) ||
            row[2].toLowerCase().includes(lowerTerm);
    });

  } else {
    document.querySelector("#btn-box").innerHTML = svgPen
    document.querySelector("#btn-box").classList.remove("filter-symbol");
  }

  console.log("DATA AFTER")
  console.log(data)
  console.log("PROCESSED")
  console.log(processed)


  if (type == "vocabulary") {

    switch (sort) {
      case "hungarianAZ":
        processed.sort((a, b) => 
          a[1].localeCompare(b[1], "hu", { sensitivity: 'base', ignorePunctuation: true }) * 1
        );
        break;
      case "hungarianZA":
        processed.sort((a, b) => 
          a[1].localeCompare(b[1], "hu", { sensitivity: 'base', ignorePunctuation: true }) * -1
        );
        break;
      case "dutchAZ":
        processed.sort((a, b) => 
          a[2].localeCompare(b[2], "nl", { sensitivity: 'base', ignorePunctuation: true }) * 1
        );
        break;
      case "dutchZA":
        processed.sort((a, b) => 
          a[2].localeCompare(b[2], "nl", { sensitivity: 'base', ignorePunctuation: true }) * -1
        );
        break;
      default:
        processed.sort((a, b) => 
          a[1].localeCompare(b[1], "hu", { sensitivity: 'base', ignorePunctuation: true }) * 1
        );
    }
  }

  showAll(type, processed)

  countFilterAndSort()




}

function countFilterAndSort() {

  let term = document.querySelector("#search-input").value
  let showMatches = document.querySelector("#found-search-input")
  let amount;


  if (btnScreen.value == 1) {
    amount = document.querySelectorAll("#vocabulary tbody > tr").length;

    if (term) {
      amount != 1 ? showMatches.innerHTML = amount+" overeenkomsten" : showMatches.innerHTML = 1+" overeenkomst" ;
    } else {
      amount != 1 ? showMatches.innerHTML = amount+" woorden" : showMatches.innerHTML = 1+" woord" ;
    }
  } 
  
  if (btnScreen.value == 3) {
    amount = document.querySelectorAll("#sentences > div").length;

    if (term) {
      amount != 1 ? showMatches.innerHTML = amount+" overeenkomsten" : showMatches.innerHTML = 1+" overeenkomst" ;
    } else {
      amount != 1 ? showMatches.innerHTML = amount+" zinnen" : showMatches.innerHTML = 1+" zin" ;
    }
  } 
  

}


function clearSortIndicators() {
  document.querySelectorAll("th").forEach(th => {
    th.classList.remove("asc", "desc");
  });
}

function updateSortIndicators(column, direction) {
  clearSortIndicators();
  let th = document.querySelector(`th[data-column="${column}"]`);
  if (th) {
    th.classList.add(direction);
  }
}

function evaluateSort(e) {

  let th = e.target.closest("#vocabulary th");
  let column = parseInt(th.dataset.column);


  if (!column) return;

  // Bepaal huidige en nieuwe sorteer richting
  let currentDirection = th.dataset.sortDirection || "asc";

  let newDirection = currentDirection === "asc" ? "desc" : "asc";
  th.dataset.sortDirection = newDirection;
  


  // Update globale sort variabele
  if (column === 1) {
    sort = newDirection === "asc" ? "hungarianAZ" : "hungarianZA";
  }
  if (column === 2) {
    sort = newDirection === "asc" ? "dutchAZ" : "dutchZA";
  }


  updateSortIndicators(column, newDirection);
  filterAndSort("vocabulary", vocabulary);
}

/*****************************/
/***** LAYOUT OPERATIONS *****/
/*****************************/



function toggleScreens(e) {

  
  let button = e.target.closest("#btn-screen")
  let value = parseInt(button.value, 10) //Always use radix 10 to avoid issues with octal interpretation.
  value != 3 ? button.value = value+1 : button.value = 1 ;

  document.querySelector("#input-box").style.display = "none";
  document.querySelector("#overlay").style.display = "none";
  document.querySelector("#spinner").style.display = "none";


  /* vocabulary */
  if (button.value == 1) {


    forceVocabularyToMaximumWidth()      
    document.querySelector("#btn-box").style.display = "block"
    document.querySelector("#grammar").style.display = "none"
    document.querySelector("#sentences").style.display = "none"
    countFilterAndSort()
    button.innerHTML = svgGram
  }
  
  /* grammar */
  if (button.value == 2) {
    document.querySelector("#btn-box").style.display = "none";
    document.querySelector("#vocabulary").style.display = "none";
    document.querySelector("#grammar").style.display = "block";
    document.querySelector("#sentences").style.display = "none"
    button.innerHTML = svgSent
  }

  /* sententorium */
  if (button.value == 3) {
    document.querySelector("#btn-box").style.display = "block";
    document.querySelector("#vocabulary").style.display = "none";
    document.querySelector("#grammar").style.display = "none"; 
    document.querySelector("#sentences").style.display = "block"
    countFilterAndSort()
    button.innerHTML = svgVoc
  }
 
}

function toggleExpandButton(e) {

  if (!e.target.closest(".btn-expand")) {

    let summary = e.target.closest(".with-expand-button")
    let button = summary.querySelector(".btn-expand")
    let details = summary.closest("details")


    if (details.open) { // the open will be set after the code underneath
      summary.style.padding = "10px 14px";
      summary.style.justifyContent = "flex-start";
      button.style.display = "none";
    } else {
      summary.style.padding = "0px 14px";
      summary.style.justifyContent = "space-between";
      button.style.display = "flex";
    }
  }
}

function toggleAllChildrenDetails(e) {



  let button = e.target.closest(".btn-expand")
  let details = button.closest("details")
  let detlvl2 = details.querySelectorAll(".det-lvl2")
  let detlvl3 = details.querySelectorAll(".det-lvl3")

  let value = parseInt(button.value, 10) //Always use radix 10 to avoid issues with octal interpretation.
  value != 3 ? button.value = value+1 : button.value = 1 ;

  // lvl2 and lvl3 closed
  if (button.value == 1) {
    for (let a of detlvl2) {a.removeAttribute("open")}
    for (let b of detlvl3) {b.removeAttribute("open")}
  }
  
  // lvl2 opened; lvl3 closed
  if (button.value == 2) {
    for (let a of detlvl2) {a.setAttribute("open", "")}
    for (let b of detlvl3) {b.removeAttribute("open")}
  }

  // lvl2 and lvl3 opened;
  if (button.value == 3) {
    for (let a of detlvl2) {a.setAttribute("open", "")}
    for (let b of detlvl3) {b.setAttribute("open", "")}
  }



}

function closeDetails(e) {

  // Ignore double-clicks on the <summary>
  if (e.target.closest('summary')) return;

  let details = e.target.closest(".det-lvl3[open]");
  if (details) {
    details.removeAttribute("open");
  }
}

function forceVocabularyToMaximumWidth() {

  let table = document.getElementById("vocabulary");

  table.style.display = "none"; // kort verbergen
  void table.offsetWidth;       // force repaint
  table.style.display = "";     // weer tonen

  // Extra: herbevestig layout
  table.style.tableLayout = "fixed";
  table.style.width = "100%";

  // Of per kolom
  const ths = table.querySelectorAll("th, td");
  ths.forEach(cell => cell.style.width = "50%");

}

function format(e) {

  let button = e.target.closest(".formatting")
  let command = button.id == "btn-list" ? "insertUnorderedList" : "bold" ;
  let value = button.value /* only for colors */
  document.execCommand(command, false, value)

}


/***** FONT SIZING *****/
  
function setFontSizeRem(el, newSize = "") {
  let size;

  if (el.tagName === 'TH') {
    if (el.classList.contains('sort-arrow')) {
      size = newSize || fontSizes.arrow;
      if (newSize) fontSizes.arrow = newSize;
    } else {
      size = newSize || fontSizes.th;
      if (newSize) fontSizes.th = newSize;
    }
  }
  if (el.tagName === 'TD') {
    size = newSize || fontSizes.td;
    if (newSize) fontSizes.td = newSize;
  }
  
  if (el.tagName === 'INPUT') {
    size = newSize || fontSizes.input;
    if (newSize) fontSizes.input = newSize;
  }
  
  if (el.tagName === 'DIV') {
    size = newSize || fontSizes.div;
    if (newSize) fontSizes.div = newSize;
  }

  if (size) el.style.fontSize = size;
}


function increaseFontSizeRem() {

 let step = 0.1
 let elements = document.querySelectorAll("*");

  elements.forEach(el => {
    let current = window.getComputedStyle(el).fontSize;
    let fontSizePx = parseFloat(current);               // current size in px
    let rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize); // base size (usually 16px)
    let currentRem = fontSizePx / rootFontSize;         // convert px to rem
    let newRem = (currentRem + step).toFixed(2);        // increase in rem
    setFontSizeRem(el, newRem + "rem")
  });
}

function decreaseFontSizeRem() {
  let step = 0.1
  let elements = document.querySelectorAll("*");

  elements.forEach(el => {
    const current = window.getComputedStyle(el).fontSize;
    const fontSizePx = parseFloat(current);               // current size in px
    const rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize); // base size (usually 16px)
    const currentRem = fontSizePx / rootFontSize;         // convert px to rem
    const newRem = (currentRem - step).toFixed(2);        // increase in rem
    setFontSizeRem(el, newRem + "rem")
  });
}



/***** INPUTBOX VISIBILITY *****/

function showInputBox(first = "") {

  document.querySelector("#input-box").style.display = "block"
  document.querySelector("#overlay").style.display = "block"
  document.querySelector("#btn-box").style.display = "none"

  if (!first) {
    document.querySelector("#btn-delete").style.display = "block"
  } else {
    document.querySelector("#btn-delete").style.display = "none"
  }
}

function closeInputBox() {

  document.querySelector("#input-box").style.display = "none"
  document.querySelector("#overlay").style.display = "none"
  document.querySelector("#btn-box").style.display = "block"
  document.querySelector("#hu").innerHTML = ""
  document.querySelector("#nl").innerHTML = ""

}



/***** SPINNER VISIBILITY *****/

function showSpinner() {
  document.getElementById("spinner").style.display = "block";
}

function closeSpinner() {
  document.getElementById("spinner").style.display = "none";
}



/****************************/
/****** EVENT HANDLERS ******/
/****************************/

['btn-box', 'btn-screen', 'btn-increase', 'btn-decrease'].forEach(id => {
    const btn = document.getElementById(id);
    btn.addEventListener('mousedown', () => {
      btn.classList.add('pressed');
    });
    btn.addEventListener('mouseup', () => {
      btn.classList.remove('pressed');
    });
    btn.addEventListener('mouseleave', () => {
      btn.classList.remove('pressed');
    });
    // Voor touchscreens
    btn.addEventListener('touchstart', () => {
      btn.classList.add('pressed');
    });
    btn.addEventListener('touchend', () => {
      btn.classList.remove('pressed');
    });
    btn.addEventListener('touchcancel', () => 
      btn.classList.remove('pressed')
    );
  });

function clickEventHandler(e) {

  if (e.target.matches("#btn-box")) { createOne() }
  if (e.target.closest("#btn-screen")) { toggleScreens(e) }
  if (e.target.matches("#btn-increase")) { increaseFontSizeRem() }
  if (e.target.matches("#btn-decrease")) { decreaseFontSizeRem() }
  if (e.target.closest(".formatting")) { format(e) }
  if (e.target.matches("#btn-save")) { saveOne() }
  if (e.target.matches("#btn-delete")) { deleteOne() }
  if (e.target.matches("#overlay")) { closeInputBox() }
  if (e.target.closest("thead th")) { evaluateSort(e) }
  if (e.target.closest(".with-expand-button")) { toggleExpandButton(e) }
  if (e.target.closest(".btn-expand")) { toggleAllChildrenDetails(e) }
}


function doubleClickEventHandler(e) {
  if (e.target.closest(".dblclick-select")) { selectOne(e) }
  if (e.target.matches("#search-input")) { e.target.value = ""; filterAndSort("vocabulary", vocabulary);  filterAndSort("sentences", sentences) }
  if (e.target.closest(".det-lvl3[open]")) {closeDetails(e)} // to close when the details are open
 
}

function keyDownEventHandler(e) {

 /* let btnSave = document.querySelector("#btn-save");
  let btnSaveStyle = window.getComputedStyle(btnSave);

  let spinner = document.querySelector("#spinner");
  let spinnerStyle = window.getComputedStyle(spinner);

   if (e.key == "Enter") {
    e.preventDefault();
    if (btnSaveStyle.display == "block" && spinnerStyle.display == "none") {
      saveOne()
    }
  }*/
}


function inputEventHandler(e) {
   if (e.target.matches("#search-input")) { evaluateFilterAndSort() }
}

function scrollEventHandler(e) {

  let currentScroll = window.pageYOffset || document.documentElement.scrollTop;
  let thead = document.querySelector("thead");

  if (currentScroll > lastScrollTop) {
    // Scrolling down
    thead.style.transform = "translateY(-100%)";
  } else {
    // Scrolling up
    thead.style.transform = "translateY(0)";
  }

  lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
}

function touchStartEventHandler(e) {
 /* if (e.target.matches(".dblclick-select")) { 
    timer = setTimeout(() => { selectOne(e) }, 750);
  }

  if (e.target.matches("#search-input")) { 
    timer = setTimeout(() => { e.target.value = "";  filterAndSort() }, 750);
  }*/
}

function touchEndEventHandler(e) {
 // if (e.target.matches(".dblclick-select")) { clearTimeout(timer) }
}

function touchCancelEventHandler(e) {
 // if (e.target.matches(".dblclick-select")) { clearTimeout(timer) }
} 

document.addEventListener("DOMContentLoaded", () => { /*readAll("all")*/ })
document.getElementsByTagName("body")[0].addEventListener("click", clickEventHandler);
document.getElementsByTagName("body")[0].addEventListener("dblclick", doubleClickEventHandler);
document.getElementsByTagName("body")[0].addEventListener("input", inputEventHandler)
document.getElementsByTagName("body")[0].addEventListener("keydown", keyDownEventHandler);
document.getElementsByTagName("body")[0].addEventListener("touchstart", touchStartEventHandler);
document.getElementsByTagName("body")[0].addEventListener("touchend", touchEndEventHandler);
document.getElementsByTagName("body")[0].addEventListener("touchcancel", touchCancelEventHandler);
window.addEventListener("scroll", scrollEventHandler);



</script>